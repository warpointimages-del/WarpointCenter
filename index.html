const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
const BOT_TOKEN = '8367657341:AAElP8RNPS-jS5LacQQ2HcpWLpc5jbrpFF0';
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAbLz1MnfjYIQMDkmqgMa09Z3W_j8dnJbM",
  authDomain: "database-a9dee.firebaseapp.com",
  databaseURL: "https://database-a9dee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "database-a9dee",
  storageBucket: "database-a9dee.firebasestorage.app",
  messagingSenderId: "68358730239",
  appId: "1:68358730239:web:21d9e409f80df8e815b7ca"
};

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
const bot = new TelegramBot(BOT_TOKEN, { polling: true });

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname)));

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¼Ð¸Ð½Ð¸-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

// API endpoint Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°
app.get('/api/schedule', async (req, res) => {
  try {
    const scheduleData = await getScheduleData();
    res.json(scheduleData);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// API endpoint Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ†Ð²ÐµÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.post('/api/update-color', async (req, res) => {
  try {
    const { userId, color } = req.body;
    await updateUserColor(userId, color);
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const miniAppUrl = `https://your-domain.com`; // Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ Ð´Ð¾Ð¼ÐµÐ½
  
  bot.sendMessage(chatId, 'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð³Ñ€Ð°Ñ„Ð¸Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹!', {
    reply_markup: {
      inline_keyboard: [[
        {
          text: 'ðŸ“… ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð³Ñ€Ð°Ñ„Ð¸Ðº',
          web_app: { url: miniAppUrl }
        }
      ]]
    }
  });
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Google Sheets Ð¸ Firebase
async function getScheduleData() {
  // Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Google Sheets
  // ÐŸÐ¾ÐºÐ° Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ
  return {
    employees: [],
    schedule: {},
    lastUpdated: new Date().toISOString()
  };
}

async function updateUserColor(userId, color) {
  // Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ†Ð²ÐµÑ‚Ð° Ð² Firebase
}

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
